---
layout:     post                    # 使用的布局（不需要改）
title:       网络层                # 标题 
subtitle:                           #副标题
date:       2020-09-05              # 时间
author:     ONLYUNIVERSE            # 作者
header-img: img/post-bg-2015.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    Computer Network
---

### 网络层所提供的服务

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务  

网络层不提供服务质量的承诺

### 网际协议IP

有三个与IP协议配套的协议：

> 地址解析协议ARP

> 网际控制报文协议ICMP

> 网际组管理协议IGMP

#### 虚拟互联网络

为了将不同的网络连接起来，我们需要使用一些中间设备

* 物理层使用转发器

* 数据链路层使用网桥或桥接器

* 网络层使用路由器

* 网络层以上使用网关

#### IP地址

每一个IP地址都由网络号和主机号构成,IP地址管理机构在分配IP地址时只需分配网络号,主机号则由相关单位自行分配;路由器也可先通过网络号直接发送至对应网络而不须考虑主机号

当一台主机同时连接到两个网络时,须分配两个(网络号)不同的IP地址;IP地址是标志一台主机和一条链路的接口

#### IP地址与硬件地址

IP地址是一种逻辑地址,而硬件地址是一种物理地址

发送端在发送数据时,须将源IP地址和目的IP地址封装在IP数据报中,而将源MAC地址和目的MAC地址封装在MAC帧里

当数据由路由器转发时,路由器将MAC帧剥离首部尾部,根据IP目的地址规划路由,再重新封装转发

在数据转发的过程中,源IP地址和目的IP地址是不发生改变的,而MAC地址每经过一次转发即被重新封装

#### 地址解析协议ARP

已知主机的IP地址,可以通过ARP找出相应的MAC地址

每一台主机中都设有一个ARP高速缓存,用于存储本局域网中所有主机/路由器的IP地址到MAC地址的映射表

当映射表中没有目的主机的MAC地址时,ARP进程在局域网内广播一个ARP请求分组,请求内容包括本机的IP地址和MAC地址、目的主机的IP地址

目的主机接收到ARP请求分组后，即向发送主机发送一份ARP响应分组(单播)，内容包括目的主机的IP地址及MAC地址

源主机接收到ARP响应分组后，即将目的主机的MAC地址写入映射表中

若是需要发送的主机不在同一个局域网内，则不能解析出该主机的MAC地址。此时，发送端只需解析出位于该局域网的路由器的MAC地址，再由该路由器继续解析跳转的，位于同一局域网的目的主机或路由器的MAC地址，最终成功完成数据传输。

#### IP数据报的格式

![ ](https://wx1.sbimg.cn/2020/09/05/95VFd.png)

* 版本号：占用4位二进制数，表示该IP数据报使用的IP协议版本。目前Internet中使用的主要是TCP/IP协议族中版本号为4的IP协议。

* 头长度：占用4位二进制位，此域指出整个报头的长度（包括选项），该长度是以32位二进制数为一个计数单位的，接收端通过此域可以计算出报头在何处结束及从何处开始读数据。普通IP数据报（没有任何选项）该字段的值是5（即20个字节的长度）。

* 服务类型（TOS、type of service）：占用8位二进制位，用于规定本数据报的处理方式。一般情况不使用

* 总长度：占用16位二进制位，总长度字段是指整个IP数据报的长度（报头区+数据区），以字节为单位。利用头部长度字段和总长度字段就可以计算出IP数据报中数据内容的起始位置和长度。由于该字段长度为16位二进制数，因此理论上IP数据报最长可达65536个字节（事实上受物理网络的限制，要比这个数值小很多）。

* 上层协议标识：占用8位二进制位，IP协议可以承载各种上层协议，目标端根据协议标识就可以把收到的IP数据报送到TCP或UDP等处理此报文的上层协议了。

* 标志：在IP数据报头部有一个叫“标志”的字段，用3位二进制数表示：  
不分片DF（Do not Fragment）标志如果被置1，则数据报在传输过程中不能被分片，如网络连通性测试命令ping就可以用-F参数设置为在数据传输时不分片，但这样当数据不能通过MTU较小的网络时，将产生数据不可达的错误。  
片未完MF（More Fragment）标志如果被置1，说明该数据报不是分片后的最后一个数据报，最后一个数据报的该位被置0。

* 片偏移：IP数据报被分片后，各片数据区在原来IP数据区中的位置用13位片偏移来表示。相对于用户数据字段的起点，该片从何处开始，即将该片首字节在原数据报中的字节位置除以8，即为片偏移量

* 生存时间（TTL，time to live）：占用8位二进制位，它指定了数据报可以在网络中传输的最长时间。实际应用中把生存时间字段设置成了数据报可以经过的最大路由器数。TTL的初始值由源主机设置（通常为32、64、128或256），一旦经过一个处理它的路由器，它的值就减1。当该字段为0时，数据报就丢弃，并发送ICMP报文通知源主机，因此可以防止进入一个循环回路时，数据报无休止地传输下去。

* 校验和：占用16位二进制数，用于协议头数据有效性的校验，可以保证IP报头区在传输时的正确性和完整性。头部检验和字段是根据IP协议头计算出的检验和，它不对头部后面的数据进行计算。

原理：发送端首先将检验和字段置0，然后对头部中每16位二进制数进行反码求和的运算，并将结果存在校验和字段中。 由于接收方在计算过程中包含了发送方放在头部的校验和，因此，如果头部在传输过程中没有发生任何差错，那么接收方计算的结果应该是全1。

* 源地址：占用32位二进制数，表示发送端IP地址。

* 目的地址：占用32位二进制数，表述目的端IP地址。

#### IP层转发分组

* 默认路由:若某路由所传输的大量的目的主机所需的下一跳为同一个路由器,则可以将此路由器设置为默认路由```0.0.0.0```,当路由表中没有目的主机的地址时,选择默认路由发送

* 特定主机路由:为了方便管理人员,可以将某台主机的IP地址直接录入路由表中,地址掩码改为```255.255.255.255```

* 路由器接收到一个待转发的数据报时,首先从路由表得到下一跳的IP地址,将该IP地址发给数据链路层,通过ARP协议得到该路由器的物理地址,再根据该物理地址找到路由器

### 划分网络

#### 划分子网

两级IP地址(网络号、主机号)容易造成IP地址的浪费，路由表的扩大和灵活性的削弱

在一个网络号下，可以划分若干子网，通过减少主机号的位数作为子网号

* 子网掩码：向路由器表示自己的子网号长度，若将目的IP地址与子网掩码逐位相与，即可得出子网的网络地址；所以子网的路由器必须将自己所在子网的子网掩码告知其他路由器，并将其加入路由表中

#### 划分超网

无分类域间路由选择CIDR

CIDR消除了传统的A、B、C类地址和子网划分，将32位的IP地址划分为网络前缀、主机号两部分

在IP地址后加上斜线```/```然后写上网络前缀所占的位数

CIDR地址块：网络前缀相同的IP地址

最长前缀匹配：使用CIDR时，由网络前缀和下一跳地址组成的IP地址可能不能得到唯一的匹配结果，此时我们从匹配结果中选择具有最长网络前缀的路由

二叉线索查找：最长前缀匹配造成的后果之一就是资源的浪费，为了进行有效的查找，我们将无分类编址的路由表存放在一种层次的数据结构中，再从根节点逐一向下查找

### ICMP(Internet Control Message Protocol)国际控制报文协议

ICMP允许主机或路由器报告差错情况/提交异常信息报告

![ ](https://wx1.sbimg.cn/2020/09/06/9Mem8.png)

ICMP报文主要有

> 差错报告报文:由头部、IP数据报首部、IP数据报数据字段的前8字节构成

* 终点不可达:路由器或主机不能交付数据报

* 时间超过: 路由器收到生存时间为0的数据报,向源点发送时间超过报文;终点不能在规定时间内收到一个完整的数据报,向源点发送时间超过报文

* 参数问题: 数据报的首部发生错误时,向源点发送参数问题报文

* 改变路由: 路由器认为本次传输有更好的路由选择

> 询问报文

* 回送请求和回答：回送请求报文是向特定主机发送的询问，收到回送请求报文的主机须发送回送回答报文，以检测目的站是否可达等情况

* 时间戳请求和回答：时间戳请求报文时请某台主机或路由器回答当前的日期和时间，回答报文中有一个32位的字段，表示从1900/01/01到现在的秒数，以进行时钟同步和时间测量

### 路由选择协议

#### 基本概念

> 理想的路由算法

* 算法必须是正确和完整的

* 算法在计算上是简单的

* 算法能适应通信量和网络拓扑的变化

* 具有稳定性

* 算法是公平的

* 算法是最佳的

> 分层次的路由选择协议

* 内部网关协议

* 外部网关协议

#### RIP

RIP要求网络中的每一个路由器都要维护从它自己到每一个目的路由的距离记录

* 仅和相邻的路由器交换信息

* 相邻的路由器交换路由表

* 每隔固定的时间交换信息

> 距离向量算法

若有相邻路由器X发送RIP报文

1. 修改下一跳的地址为X，距离+1

2. 若原路由表没有该目的网络，添加，否则转3

3. 若路由表中下一跳为X，替换，否则转4

4. 若距离小于原路由表中距离，更新，否则什么也不操作

若3分钟没有收到相邻路由器的信息，将该路由器设为不可达

> RIP报文格式

RIP协议使用运输层用户数据报UDP进行传送

![ ](https://wx1.sbimg.cn/2020/09/06/9XLBD.png)

#### OSPF

![ ](https://raw.githubusercontent.com/ONLYUNIVERSE/ONLYUNIVERSE.github.io/master/Img/home-bg-o.jpg)